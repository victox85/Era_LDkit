import { DataFactory } from "../rdf.js";
import { xsd } from "../../namespaces/xsd.js";
import { stringify } from "./stringify.js";
/**
 * A template tag for SPARQL queries or its parts. Automatically converts
 * values to SPARQL literals and escapes strings as needed.
 *
 * @example
 * ```typescript
 * import { sparql } from "ldkit/sparql";
 * import { DataFactory } from "ldkit/rdf";
 *
 * const df = new DataFactory();
 * const quad = df.quad(
 *   df.namedNode("http://example.org/s"),
 *   df.namedNode("http://example.org/p"),
 *   df.literal("o"),
 * );
 * const query = sparql`SELECT * WHERE { ${quad} }`;
 * console.log(query); // SELECT * WHERE { <http://example.org/s> <http://example.org/p> "o" . }
 * ```
 *
 * @param strings {TemplateStringsArray} template strings
 * @param values {SparqlValue[]}
 * @returns {string} SPARQL query or its part
 */
export const sparql = (strings, ...values) => {
    let counter = 0;
    let result = "";
    for (const value of values) {
        result += strings[counter++];
        result += valueToString(value);
    }
    result += strings[counter];
    return result;
};
const isIterable = (obj) => {
    return Symbol.iterator in Object(obj);
};
const df = new DataFactory();
const valueToString = (value) => {
    if (typeof value === "undefined" || value === null) {
        return "";
    }
    if (typeof value === "string") {
        return value;
    }
    if (typeof value === "number") {
        const numberDataType = Number.isInteger(value) ? xsd.integer : xsd.decimal;
        return stringify(df.literal(value.toString(), df.namedNode(numberDataType)));
    }
    if (typeof value === "boolean") {
        return stringify(df.literal(value.toString(), df.namedNode(xsd.boolean)));
    }
    if (value instanceof Date) {
        return stringify(df.literal(value.toISOString(), df.namedNode(xsd.dateTime)));
    }
    if (isIterable(value)) {
        const [first, ...rest] = value;
        let result = valueToString(first);
        for (const part of rest) {
            result += `\n${valueToString(part)}`;
        }
        return result;
    }
    if ("build" in value) {
        return value.build();
    }
    if (value.termType) {
        return stringify(value);
    }
    throw new Error("Not supported input type detected.");
};
